name: Scheduled Content Review with Professor

# This workflow runs on a schedule to review and improve existing content
# using Professor's review and quality assurance capabilities

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      content_path:
        description: 'Path to content to review'
        required: false
        type: string
        default: 'published/'
      review_types:
        description: 'Types of reviews to perform'
        required: false
        type: choice
        options:
          - 'All reviews (pedagogy, accessibility, bias)'
          - 'Pedagogy only'
          - 'Accessibility only'
          - 'Bias check only'
        default: 'All reviews (pedagogy, accessibility, bias)'

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  review-content:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Professor Framework
        id: setup-professor
        uses: ./.github/actions/setup-professor
        with:
          professor_branch: 'master'
          github_token: ${{ secrets.GITHUB_TOKEN }}
          merge_with_local: 'true'

      - name: Determine review scope
        id: scope
        run: |
          CONTENT_PATH="${{ inputs.content_path || 'published/' }}"
          REVIEW_TYPES="${{ inputs.review_types || 'All reviews (pedagogy, accessibility, bias)' }}"

          echo "content_path=$CONTENT_PATH" >> $GITHUB_OUTPUT
          echo "review_types=$REVIEW_TYPES" >> $GITHUB_OUTPUT

          # Check if content exists
          if [ ! -d "$CONTENT_PATH" ]; then
            echo "âš  Warning: Content path $CONTENT_PATH does not exist"
            mkdir -p "$CONTENT_PATH"
          fi

          FILE_COUNT=$(find "$CONTENT_PATH" -type f \( -name "*.md" -o -name "*.html" \) | wc -l)
          echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
          echo "Found $FILE_COUNT content files to review"

      - name: Execute content review with Claude
        if: steps.scope.outputs.file_count > 0
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            Please perform a comprehensive content review using Professor framework's review capabilities.

            **Content Path**: ${{ steps.scope.outputs.content_path }}
            **Review Types**: ${{ steps.scope.outputs.review_types }}
            **Files Found**: ${{ steps.scope.outputs.file_count }}

            Use Professor review skills:
            - /curriculum.review-pedagogy --materials "${{ steps.scope.outputs.content_path }}"
            - /curriculum.review-accessibility --materials "${{ steps.scope.outputs.content_path }}" --standard "WCAG-2.1"
            - /curriculum.review-bias --materials "${{ steps.scope.outputs.content_path }}"

            For each content file:
            1. Review pedagogical soundness (alignment, clarity, effectiveness)
            2. Check accessibility compliance (WCAG 2.1 AA minimum)
            3. Detect any bias or cultural insensitivity
            4. Provide specific, actionable recommendations
            5. Rate each file on a quality scale

            Generate a comprehensive review report in markdown format.
            Save the report to: reviews/content-review-${{ github.run_number }}.md

            If critical issues are found, create a detailed action plan for remediation.
          claude_args: '--max-turns 15'

      - name: Create issue for review findings
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'reviews/content-review-${{ github.run_number }}.md';

            let reviewContent = 'No review report generated';
            if (fs.existsSync(path)) {
              reviewContent = fs.readFileSync(path, 'utf8');
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ“‹ Content Review Report - ${new Date().toISOString().split('T')[0]}`,
              body: `## Automated Content Review\n\n` +
                    `**Date**: ${new Date().toISOString()}\n` +
                    `**Content Path**: \`${{ steps.scope.outputs.content_path }}\`\n` +
                    `**Files Reviewed**: ${{ steps.scope.outputs.file_count }}\n` +
                    `**Review Types**: ${{ steps.scope.outputs.review_types }}\n\n` +
                    `### Review Report\n\n` +
                    reviewContent + `\n\n` +
                    `---\n` +
                    `ðŸ¤– Generated by Professor Framework automated review`,
              labels: ['content-review', 'automated', 'professor']
            });

      - name: Generate summary
        if: always()
        run: |
          echo "## ðŸ“Š Content Review Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Content Path**: \`${{ steps.scope.outputs.content_path }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Files Reviewed**: ${{ steps.scope.outputs.file_count }}" >> $GITHUB_STEP_SUMMARY
          echo "**Review Types**: ${{ steps.scope.outputs.review_types }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Professor Framework:" >> $GITHUB_STEP_SUMMARY
          echo "- Skills: ${{ steps.setup-professor.outputs.skills_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- Agents: ${{ steps.setup-professor.outputs.agents_count }}" >> $GITHUB_STEP_SUMMARY
